<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter un Emprunt</title>
    <!-- Ajouter le stylesheet Bootstrap pour la mise en forme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-4">
    <h1>Ajouter un Emprunt</h1>

    <!-- Formulaire pour ajouter un emprunt -->
    <form action="/add_emprunt" method="POST">
        <!-- Sélectionner un abonné -->
        <div class="form-group">
            <label for="abonne_id">Abonné :</label>
            <select class="form-control" id="abonne_id" name="abonne_id" required>
                {% for abonne in abonnes %}
                    <option value="{{ abonne._id }}">{{ abonne.nom }} {{ abonne.prenom }}</option>
                {% else %}
                    <option disabled>Aucun abonné trouvé</option>
                {% endfor %}
            </select>
        </div>

        <!-- Sélectionner un document -->
        <div class="form-group">
            <label for="document_id">Document :</label>
           
            <select class="form-control" id="document_id" name="document_id" required>
                {% for document in documents %}
                    <option value="{{ document._id }}">{{ document.titre }}</option>
                {% else %}
                    <option disabled>Aucun document trouvé</option>
                {% endfor %}
            </select>
        </div>

<!-- Date d'emprunt -->
<div class="form-group">
    <label for="date_emprunt">Date d'emprunt :</label>
    <input type="date" class="form-control" id="date_emprunt" name="date_emprunt" value="{{ current_date }}" disabled>
</div>


        <!-- Date de retour prévue -->
        <div class="form-group">
            <label for="date_retour_prevu">Date de retour prévue :</label>
            <input type="date" class="form-control" id="date_retour_prevu" name="date_retour_prevu" required>
        </div>

       

        

        <button type="submit" class="btn btn-primary">Ajouter</button>
        <a href="/emprunts" class="btn btn-secondary">Retour à la liste des emprunts</a>
    </form>
</div>

</body>
</html>

<script>
    document.querySelector("form").addEventListener("submit", function (event) {
        event.preventDefault(); // Empêche le rechargement de la page
    
        // Récupérer les valeurs des champs
        const abonneId = document.getElementById("abonne_id").value;
        const documentId = document.getElementById("document_id").value;
        const dateRetourPrevu = document.getElementById("date_retour_prevu").value;
    
        // Envoyer une requête POST au backend
        fetch('/add_emprunt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                abonne_id: abonneId,
                document_id: documentId,
                date_retour_prevu: dateRetourPrevu,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Affiche uniquement le popup pour une erreur liée à la date
                    if (data.error.includes("date de retour")) {
                        alert("Erreur : " + data.error);
                    }
                } else {
                    // Succès
                    alert("Succès : " + data.message);
                    // Réinitialiser le formulaire après succès
                    document.querySelector("form").reset();
                    // Optionnel : rediriger après succès
                    window.location.href = '/emprunts';
                }
            })
            .catch(error => console.error('Erreur:', error));
    });
    </script>
    







